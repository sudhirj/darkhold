#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

if ! command -v air >/dev/null 2>&1; then
  echo "air is not installed. Install it with: go install github.com/air-verse/air@latest"
  exit 1
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "npm is required to run the web HMR server"
  exit 1
fi

# Ensure embedded web assets exist for the Go server root (:3275).
npm --prefix clients/web run build

cleanup() {
  set +e
  if [[ -n "${GO_PID:-}" ]]; then kill "$GO_PID" 2>/dev/null; fi
  if [[ -n "${WEB_PID:-}" ]]; then kill "$WEB_PID" 2>/dev/null; fi
  wait "$GO_PID" "$WEB_PID" 2>/dev/null
}
trap cleanup EXIT INT TERM

air -c .air.go.toml &
GO_PID=$!

npm --prefix clients/web run dev -- --host 127.0.0.1 --port 5173 &
WEB_PID=$!

while true; do
  if ! kill -0 "$GO_PID" 2>/dev/null; then
    wait "$GO_PID" || true
    break
  fi
  if ! kill -0 "$WEB_PID" 2>/dev/null; then
    wait "$WEB_PID" || true
    break
  fi
  sleep 1
done
