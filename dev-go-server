#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

mkdir -p .tmp/go-cache .tmp/go-tmp .tmp/bin

: "${BIND:=0.0.0.0}"
: "${PORT:=3275}"
: "${ALLOW_CIDR:=100.64.0.0/10}"

BIN_PATH=".tmp/bin/darkhold-go"
LOG_PATH=".tmp/go-server.log"

npm --prefix clients/web run build

GOCACHE="$ROOT_DIR/.tmp/go-cache" \
GOTMPDIR="$ROOT_DIR/.tmp/go-tmp" \
  go build -o "$BIN_PATH" ./cmd/darkhold

echo "Built $BIN_PATH"
echo "Starting Go server on http://${BIND}:${PORT}"

"$BIN_PATH" \
  --bind "$BIND" \
  --port "$PORT" \
  --allow-cidr "$ALLOW_CIDR" \
  "$@" 2>&1 | tee "$LOG_PATH"
